name: Deploy IA buildPlanSpec + lessonChat (code-only)

on:
  push:
    branches: [ main, qa ]
  workflow_dispatch:
    inputs:
      stage:
        description: "Stage (dev|qa|main)"
        required: false
        default: ""

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    # Elegimos environment seg√∫n branch o input manual
    environment: ${{ github.event_name == 'workflow_dispatch'
        && (inputs.stage != '' && inputs.stage || (github.ref == 'refs/heads/main' && 'dev' || 'qa'))
        || (github.ref == 'refs/heads/main' && 'dev' || 'qa') }}

    env:
      AWS_REGION: us-east-1
      NODE_VERSION: 20
      SERVICE_DIR: .   # el repo ES ia-service

    steps:
      - name: üîÑ Checkout
        uses: actions/checkout@v4

      - name: üîé Resolve STAGE
        id: stage
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] && [ -n "${{ inputs.stage }}" ]; then
            STAGE="${{ inputs.stage }}"
          else
            # main -> dev, cualquier otra (qa) -> qa
            STAGE=$([ "${{ github.ref }}" = "refs/heads/main" ] && echo "dev" || echo "qa")
          fi
          echo "STAGE=$STAGE" >> "$GITHUB_OUTPUT"

      - name: üèóÔ∏è Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: üì¶ Install deps
        working-directory: ${{ env.SERVICE_DIR }}
        run: |
          if [ -f package-lock.json ] || [ -f npm-shrinkwrap.json ]; then
            npm ci --omit=dev
          else
            npm i --omit=dev --no-audit --no-fund
          fi

      - name: üß∑ Package ZIP (code-only)
        working-directory: ${{ env.SERVICE_DIR }}
        shell: bash
        run: |
          ZIP="ia-service-src.zip"
          # incluimos src + node_modules + package.json (+ lock si existe)
          if [ -f package-lock.json ]; then
            zip -r "$ZIP" src/ node_modules/ package.json package-lock.json
          else
            zip -r "$ZIP" src/ node_modules/ package.json
          fi
          echo "ZIP_FILE=$ZIP" >> "$GITHUB_ENV"

      - name: üîê Configure AWS
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region:            ${{ env.AWS_REGION }}

      # üîπ Actualizar variables de entorno en ambas Lambdas
      - name: ‚öôÔ∏è Update functions configuration (env)
        shell: bash
        run: |
          STAGE="${{ steps.stage.outputs.STAGE }}"
          for FN in buildPlanSpec lessonChat; do
            NAME="ia-service-${STAGE}-${FN}"
            echo "Updating configuration for $NAME ..."
            aws lambda update-function-configuration \
              --function-name "$NAME" \
              --environment "Variables={STAGE=${STAGE},GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }},GEMINI_MODEL_ID=${{ secrets.GEMINI_MODEL_ID }}}"

            aws lambda wait function-updated --function-name "$NAME"
          done

      # üîπ Actualizar c√≥digo en ambas Lambdas con el mismo ZIP
      - name: üöÄ Update functions code (buildPlanSpec + lessonChat)
        shell: bash
        run: |
          STAGE="${{ steps.stage.outputs.STAGE }}"
          ZIP_FILE="${{ env.ZIP_FILE }}"

          for FN in buildPlanSpec lessonChat; do
            NAME="ia-service-${STAGE}-${FN}"
            echo "Updating code for $NAME with $ZIP_FILE ..."

            n=0
            until aws lambda update-function-code \
                    --function-name "$NAME" \
                    --zip-file "fileb://${ZIP_FILE}" \
                    --publish >/dev/null; do
              n=$((n+1))
              echo "Retry $n for $NAME ..."
              [ $n -ge 5 ] && { echo "‚ùå Failed updating $NAME"; exit 1; }
              sleep 5
            done

            aws lambda wait function-updated --function-name "$NAME"
          done
